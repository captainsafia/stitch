+++
id = "S-20251228-4704"
title = "Add self-update command and version check"
status = "closed"
created_at = "2025-12-29T00:24:49.171Z"
updated_at = "2025-12-29T00:25:10.496Z"
provenance = "agent"
confidence = "high"
tags = ["feature", "cli", "update"]

[scope]
paths = ["src/platform/update/", "src/cli.ts", "tests/version.test.ts"]

[[git.links]]
kind = "commit"
sha = "fb62f036f7212d46868491b2bb86f317acb291d1"
+++

## Intent

Add a self-update command to the stitch CLI that allows users to update their installation to the latest version, and add a startup version check that notifies users when updates are available.

## Features Implemented

### `stitch update` Command

Options:
- `--target <version>` - Install a specific version
- `--preview` - Install the latest preview version
- `--yes` - Skip confirmation prompt

Supports multiple installation methods:
- **Binary**: Downloads and replaces the executable
- **npm**: Runs `npm install -g @captainsafia/stitch@<version>`
- **bun**: Runs `bun install -g @captainsafia/stitch@<version>`
- **dev**: Shows informational message (cannot update in dev mode)

### Startup Version Check

- Non-blocking check that runs in the background
- Cached for 24 hours to avoid excessive API calls
- Outputs to stderr so it doesn't interfere with piped output
- Skipped for `update`, `--help`, and `--version` commands

## Architecture

New module at `src/platform/update/`:
- `types.ts` - Type definitions (Platform, InstallMethod, UpdateCheckCache, UpdateResult)
- `version.ts` - Version parsing and comparison utilities
- `check.ts` - Cached version checking via GitHub Releases API
- `download.ts` - Platform detection and binary download with progress
- `install.ts` - Installation logic for each method with rollback support

## Alternatives Considered

1. **npm-only update** - Would exclude binary users who don't have npm/bun
2. **Manual download instructions** - Poor UX, requires user to know their platform
3. **Always check on startup** - Would slow down every command; rejected for caching approach

## Notes

- Uses GitHub Releases API (`/repos/captainsafia/stitch/releases`)
- Binary replacement uses rename strategy (current -> .old, new -> current) for atomic updates
- Rollback on failure ensures CLI remains functional if update fails
