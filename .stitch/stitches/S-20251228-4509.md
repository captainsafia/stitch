+++
id = "S-20251228-4509"
title = "Add preview release support and fix CLI version reading"
status = "open"
created_at = "2025-12-28T18:04:23.000Z"
updated_at = "2025-12-28T18:31:28.765Z"
provenance = "agent"
confidence = "high"
tags = [ "ci", "release", "cli" ]

[scope]
paths = [ ".github/workflows/release.yml", "src/cli.ts" ]

[[git.links]]
kind = "commit"
sha = "4d6790f93eec07a9274dc0cb0b26fdf4cb3ba8cf"
+++

## Intent

Add support for automated preview releases when pushing to the main branch, following the pattern used in the burrow project. Also fix the CLI to read the version from the actual package.json file instead of a hardcoded mock value.

## Changes

### release.yml
- Trigger on both `v*.*.*` tags AND pushes to `main` branch
- Dynamic version generation:
  - Tags: Extract version from tag (strip `v` prefix)
  - Main branch: Generate preview version like `1.0.0-preview.{short-sha}`
- Consolidated build job that handles both scenarios
- New `prerelease` job for main branch pushes:
  - Publishes to npm with `--tag preview`
  - Creates GitHub prerelease with installation instructions
- Existing `release` job now conditional on tags only
- Added `--provenance` flag for npm publishing (supply chain security)
- Added `id-token: write` permission for provenance

### cli.ts
- Changed from hardcoded version object to dynamic import of package.json
- CLI now reads version and description from the actual package.json

## Constraints

- Preview releases must not overwrite stable releases on npm
- Version numbers must be valid semver (preview suffix format: `X.Y.Z-preview.{sha}`)
- Both release types use the same build artifacts

## Notes

Preview releases are accessible via:
- `npm install @captainsafia/stitch@preview`
- GitHub prereleases page
